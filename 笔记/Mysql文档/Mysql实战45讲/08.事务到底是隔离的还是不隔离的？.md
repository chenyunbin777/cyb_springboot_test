# 

# 事物的启动时机
- begin/start transaction 命令并不是一个事务的起点，在执行到它们之后的第一个操作InnoDB表 的语句，事务才真正启动。
- 如果你想要马上启动一个事务，可以使用**start transaction with consistent snapshot** 这个命令。

# 在MySQL里，有两个“视图”的概念：

- 1、一个是view。它是一个用查询语句定义的虚拟表，在调用的时候执行查询语句并生成结果。 创建视图的语法是create view…，而它的查询方法与表一样。
- 2、另一个是InnoDB在实现M致性读视图，即consistent read view，
  - 用于支持 RC（Read Committed，读提交）
  - 和RR（Repeatable Read，可重复读）隔离级别的实现。

- 例如：是可重复读隔离级别，事务T启动的时 候会创建一个视图read-view，之后事务T执行期间，即使有其他事务修改了数据，事务T看到的 仍然跟在启动时看到的一样。
- 默认 autocommit=1


# “快照”在MVCC里是怎么工作的？

- 可重复读的定义，一个事务启动的时候，能够看到所有已经提交的事务结果。但是之后，这个事务执行期间，其他事务的更新对它不可见。
  - 因此，一个事务只需要在启动的时候声明说，“以我启动的时刻为准，如果一个数据版本是在我 启动之前生成的，就认；
  - 如果是我启动以后才生成的，我就不认，我必须要找到它的上一个版本”。
    - InnoDB为每个事务构造了一个数组，用来保存这个事务启动瞬间，当前正在 **“活跃”的所有事务ID**。“活跃”指的就是，**启动了但还没提交**

      - 例如当前活跃的事务ID：2，6，9，11
        - 数组里面事务ID的最小值记为低水位，当前系统里面**已经创建过的事务ID（包括目前还未提交的事务ID）的最大值加1**记为高水位。
          - 低水位：2
          - 高水位：11+1 = 12
          - 
                  低水位   高水位
                   ⬇️       ⬇️
            🟩🟩🟩🟩🟨🟨🟨🟨🟥🟥🟥🟥
          - 绿色：已经提交事务，黄色：未提交事务集合，红色：未开始事务
          - 1、如果落在绿色部分，表示这个版本是已提交的事务或者是当前事务自己生成的，这个数据是可见的；
          - 2、如果落在红色部分，表示这个版本是由将来启动的事务生成的，是肯定不可见的； 
          - 3、如果落在黄色部分，那就包括两种情况 
           - a. 若 rowtrx_id在数组中，表示这个版本是由还没提交的事务生成的，不可见； 
           - b. 若 rowtrx_id不在数组中，表示这个版本是已经提交了的事务生成的，可见。


- 更新数据都是先读后写的，而这个读，只能读当前的值，称为值 “当前读”（current read）。
  - 如果事务A在这之前有其他事务B更新了相同的值，那么就会读到事务B更新的值