# 一 对外分享
1 专有云的v2：专有云私有化部署的主站服务
2 开放平台：提供企业授权码，通过校验企业授权码的方式来判断该企业是否有权限创建对外分享
3 公有云的v2
4 公有云v2账号

大概流程描述：专有云v2通过开放平台的授权，我们将创建分享链接的请求通过开放平台的代理来发送给公有云的v2，创建可以在外网访问的分享链接。

## 容错机制
- 在创建分享链接的途中，难免会遇到网络、代码异常的问题，我们会增加重试机制并且设置重试次数，避免请求过多对于服务器的冲击。

## 外网网盘失效文件占空间
- 设置定时检查任务，将失效分享链接中的文件定时删除，这过程其实用户是不会有感知的。
- 使用contab 设置php定时间检查脚本

## 网盘空间不足预警
- 短信预警、系统消息预警、邮件通知

## 遇到的问题与挑战
- 这是我在亿方云第一个项目，对我的挑战和提升也是非常的大。
- 1 编程语言的挑战，第一次接触php编程项目，刚开始也是一头雾水、举步维艰。
我的处理办法就是，首先要了解php代码的使用方式，从表面入手一点点的了解他的语法，在对比他与java的不同，慢慢练习，逐步的习惯他的
使用方式和语法结构。 到最后养成习惯之后，也就水到渠成。

- 2 php服务与其他服务的交互模式
在java中，我们现在一般都是使用的微服务，采用的dubbo RPC的方式与其他服务交互。现有服务的处理方式有所不同，是使用的http短连接的方式
来与其他服务交互。

## 实现过程
- 




# 二 自定义水印
- 我们的客户可以在亿方云的后台管理中设置在预览文件时的水印格式，如 颜色 水印格式 文字大小等。
这其中就设计到了我们的几服务接口的改造，v2，transformer。
v2：要兼容用户的个性化定制水印，也要考虑到多个方面。
- 1 设置自定义水印白名单
- 2 分享文件自定义水印
- 3 个人文件自定义水印
- 4 部门自定义水印
- 5 自定义水印文件的缓存机制：我们需要当客户预览转换好文件之后，再下一次打开文件时，不需要重新转换文件，直接通过我们的缓存来获取
文件进行预览，提升整体预览的效率。
还要就是保证在打开自定义水印预览完成的文件，在关闭白名单之后，文件也可以正常的展示非自定义的默认水印。

    - 处理方式
    - 1 **设置文件标志位**，自定义水印、默认水印、无水印，无论我们的白名单如何切换，都可以保证水印展示的正确性
    - 2 保证文件的安全性，对预览文件的下载链接设置过期时间，对文件进行加密，防止敏感信息文件的泄漏。
        - 我们的加密方式：前后端规定好文件的加密方式，后端会生成一个文件的解密秘钥，前端通过该秘钥进行文件解密。（该秘钥并不是文件的密码）
    - 3 多种预览方式的兼容：
        - office类型文件：如果开通了wps服务的企业可以通过wps的水印来进行接入； 
        如果没有开通wps，我们会使用office online预览或者aspose进行水印预览；
        如果wps、office online都不支持的我们会通过aspose来进行转换。
        - 图片：我们使用的是ImageMagic 进行水印预览
            - 一些特殊类型的文件：eps ps类型图片，使用gs命令
        - text类型文件：我们使用的是iText框架进行预览，将其转换成pdf文件。
        
    - 4 cad：dwg 通过浩辰cad来进行无水印预览，有水印预览通过一个开源的软件AcmeCADConverter水印预览


# wps 预览降级
- 背景：有一些企业使用比较老的版本的浏览器或者老版本的安卓系统，对于wps预览中台的不兼容，所以需要使用其他的方式来进行预览。
由于我们自研的transformer转换程序效率没有wps高，所以选取wps  转换服务。

- 我们使用是wps中的一个转换文件的服务，可以将一些wps支持的office类型文件转换成pdf的方式进行预览。
- 服务：v2主站，wps预览中台服务，wps私有化部署集群，上传下载服务
- 流程：
    - v2主站=》
    - wps预览中台服务，去请求wps预览中台集群，
    - 转换完成之后，调用wps预览中台服务的 **回调方法告知** 我们转换完成，此时我们设置一个redis标志位说明是哪个文件，转换状态如何
    - 我们会在主站进行轮询请求这个文件的转换状态，不断的去Redis中取该状态值，取到之后会判断转换是否成功。
    如果成功就通过返回的download_id去请求下载文件； 如果转换失败，我们就**失败降级**到自研的transformer中去转换预览文件（缓存）
    
    
# cad 专有云定制化
- cad可定制化需求，可配置、专有云快速部署，提供规范的部署方式，
- 厦门金圆集团、建设银行、鄂尔多斯、天津雅迪等
    
    

对于 "祖传" 代码 这种情况，你是允许他肆意扩张代码量，还是有其他什么办法来解决？