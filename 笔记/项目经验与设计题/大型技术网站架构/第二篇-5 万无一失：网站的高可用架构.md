# 第二篇 架构篇

# 5 万无一失：网站的高可用架构
## 5.1 网站的可用性的度量和考核
- 网站年度可用性指标= （1-网站不可用时间/年度总时间） * 100%
- 2个9是基本可用；3个9是较高可用，不可用时间小于9小时；4个9 小于53分钟 
- 4 5个9不仅需要工程师的不懈努力，更需要有个好运气。

## 5.2 高可用的网站架构
- 分层架构
    - 应用层
    - 服务层
    - 数据层
    

- 实现高可用架构的主要手段是，数据和服务的冗余备份和失效转移，当服务器硬件不可用时要及时转移到其他可用的服务器上，
如果磁盘损坏，则从备份磁盘读取。
- 磁盘数据的备份分为 冷备份 和 热备份。定时冷备份，实时热备份
- 应用层
    - 负载均衡：保证集群服务器可以均匀的接受请求，不会出现某一台或几台服务器请求量巨大，而其他的一些服务器请求很小的情况
    - 心跳检测：当服务器不可用的时候，心跳检测可以观测的到，及时**故障转移**将请求打到其他可用服务器。并且将当前服务器及时重启或者剔除。
    
- 数据层
    - 与应用层类似，通过软负载均衡，注册中心，将不可用服务剔除，将**数据请求**转移到可用服务器。
    - 我们还可以通过 "写时复制"，创建备份数据
    
    
## 5.3 高可用的应用
- 1 应用的无状态性，应用层所有的服务器都是无状态的，请求到哪一个服务器都是一样的。
    - 也是通过负载均衡进行故障转移。
    - 用户请求=》负载均衡服务器（多层SLB）（这里也应该是个集群，保证高可用性）=》应用层集群

    - 七层SLB、四层LB
        - https://www.songma.com/news/txtlist_i67066v.html
        - 目前SLB有四层SLB（TCP/UDP）与七层SLB（HTTP/HTTPS）两种，其中四层SLB是基于IP与端口的负载均衡，而七层SLB是基于URL等应用层内容的负载均衡。
  四层SLB（TCP/UDP）：SLB根据VIP加端口号来做负载均衡，进行处理后转发至后台RS（RealServer后台真正的服务器），并记录下这个TCP或者UDP的流量是由哪台RS处理的，后续这个连接的所有流量都同样转发到同一台RS处理。
  七层SLB（HTTP/HTTPS）：在四层的基础上，再考虑应用层的特征，除了根据 VIP加端口还可根据七层的SRL等信息来进行负载均衡。 若您的业务无需针对应用层的信息做负载均衡，仅需监听IP与端口，可选择四层SLB服务，如需根据SRL、域名等应用层信息来进行负载均衡，或需要HTTP的健康探测，则需选择七层SLB。

- 2 有状态的服务器Session管理
    - 利用网站Cookie记录Session，Session记录在客户端，每次请求将Session放在请求中发送给服务器。
 
## 5.4 高可用的服务
- 核心服务与非核心服务隔离，分别集群部署

- 设置请求超时，重试，异常处理；failover到其他服务器

- 异步调用，执行成功之后，异步通知（邮件、短信、应用内消息提醒）

- 服务降级 熔断

- 幂等性设计

## 5.5 高可用的数据

- 冷热备份，定时备份、写时备份
    - 冷备：优点是简单、廉价，成本和技术难度都较低。 缺点是不能保证数据最终一致性，可能备份的数据是比系统中数据陈旧的。
    - 热备：一般我们的存储是 master-多slave的方式
        - 异步热备：当数据写入完成返回时，进行数据异步的热备，通过异步线程同步给slave，不能保证每次都成功。 优点对应用系统基本无影响，效率高。
        - 同步热备：当数据在master 和 slave都是写入成功之后才会返回给应用服务器成功状态。
    - DB 通过master-slave模式的同步热备份，也可以实现读写分离。因为master和slave中的所有数据都是一致的
    
       
- 分布式缓存集群

- 1 CAP原理
    - 可用性，任何时候，任何应用程序都可以读写访问
    - 数据一致性，所有的服务器都可以获取到相同的数据。
        - 达到数据的最终一致性即可，没必要追求数据的强一致性
    - 分区容错性，系统可以跨网络分区先行伸缩
    
- 2 数据备份
    -  mysql导出数据，可以**写一个脚本定时备份数据**
        - 使用 SELECT ... INTO OUTFILE 语句导出数据
        - mysqldump 是 mysql 用于转存储数据库的实用程序。它主要产生一个 SQL 脚本，其中包含从头重新创建数据库所必需的命令 CREATE TABLE INSERT 等。
        - - 导出整个数据库的数据：mysqldump -u root -p RUNOOB > database_dump.txt
        - - 备份所有数据库：mysqldump -u root -p --all-databases > database_dump.txt
    - mysql导入数据
        - mysql -u用户名 -p密码 <  要导入的数据库数据(runoob.sql)
      将备份的整个数据库 runoob.sql 导入：mysql -uroot -p123456 < runoob.sql
        - source 命令导入
        mysql> create database abc;      # 创建数据库
         mysql> use abc;                  # 使用已创建的数据库 
        mysql> set names utf8;           # 设置编码
        mysql> source /home/abc/abc.sql  # 导入备份数据库    

- 3 失效转移

## 5.6 高可用网站的软件质量保证

- 1 网站发布
    - 服务器逐步发布，通过负载均衡服务器逐步重启服务，并且不会影响到线上服务器的正常使用。
- 2 自动化测试

- 3 预发布验证

- 4 代码控制：使用git进行版本控制，发布tag，与回滚

- 5 灰度发布，也叫做ABtest

## 5.7 网站运行监控

- 用户行为日志收集

- 服务端日志 客户端日志

- 系统报警

- 失效转移

- 自动优雅降级：非核心服务降级

